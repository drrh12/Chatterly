# MVP Language Exchange App - Backend

This directory contains the backend source code for the MVP Language Exchange App, built using Firebase (Firestore, Cloud Functions, and Firebase Authentication).

## Table of Contents

- [Overview](#overview)
- [Folder Structure](#folder-structure)
- [Prerequisites](#prerequisites)
- [Setup](#setup)
  - [1. Firebase Project Setup](#1-firebase-project-setup)
  - [2. Local Environment Setup](#2-local-environment-setup)
- [Running Locally with Firebase Emulators](#running-locally-with-firebase-emulators)
- [Deploying to Firebase](#deploying-to-firebase)
- [Key Components](#key-components)
  - [Firestore Security Rules](#firestore-security-rules)
  - [Cloud Functions](#cloud-functions)
  - [Firestore Data Structure](#firestore-data-structure)
- [Testing](#testing)

## Overview

The backend handles user authentication, profile management, chat creation, message sending, and user blocking functionalities. It leverages:

-   **Firebase Authentication:** For user sign-up/login (Email, Google, Apple).
-   **Firestore:** As the NoSQL database for storing user profiles, chat metadata, and messages.
-   **Cloud Functions (Node.js):** For server-side logic such as creating user profiles upon registration, managing chat creation, and handling blocking logic.

## Folder Structure

```
backend/
├── firestore.rules                 # Firestore security rules
├── functions/                      # Cloud Functions source code
│   ├── index.js                    # Main file for Cloud Functions
│   ├── package.json                # Node.js dependencies for functions
│   └── package-lock.json           # (Generated by npm)
├── firestore-schema-example.json   # Example of the Firestore data structure
├── firebase-optimization-tips.md   # Tips for Firebase cost/performance
└── README.md                       # This file
```

The project root (e.g., `Chatterly/`) will contain `firebase.json` and `.firebaserc` after `firebase init` is run there.

## Prerequisites

-   [Node.js](https://nodejs.org/) (version specified in `backend/functions/package.json`, e.g., 18.x or higher)
-   [npm](https://www.npmjs.com/) (comes with Node.js)
-   [Firebase CLI](https://firebase.google.com/docs/cli#install_the_firebase_cli)

## Setup

### 1. Firebase Project Setup

1.  Go to the [Firebase Console](https://console.firebase.google.com/).
2.  Create a new Firebase project (or use an existing one if appropriate).
3.  In your project, enable the following services:
    *   **Authentication:** Enable Email/Password, Google, and Apple sign-in methods.
    *   **Firestore:** Create a Firestore database. You can start in "test mode" for initial setup, but ensure you deploy security rules before production.

### 2. Local Environment Setup

1.  **Clone the Repository (if applicable):**
    If you haven't already, clone the main project repository.
2.  **Install Firebase CLI:**
    If not already installed, run:
    ```bash
    npm install -g firebase-tools
    ```
3.  **Login to Firebase CLI:**
    ```bash
    firebase login
    ```
    Ensure you log in with the Google account that has access to your Firebase project.
4.  **Initialize Firebase in the Project Root:**
    Navigate to the **root directory of the overall project** (e.g., `Chatterly/`, the parent of this `backend` directory). Run:
    ```bash
    firebase init
    ```
    Follow the prompts:
    *   Select features: **Firestore**, **Functions**, and **Emulators**.
    *   Link to your Firebase project created in the Firebase Console.
    *   **Firestore:**
        *   Rules file: `backend/firestore.rules`
        *   Indexes file: (default `firestore.indexes.json`)
    *   **Functions:**
        *   Language: JavaScript
        *   ESLint: Yes
        *   `package.json` in `backend/functions/` will be used/updated.
        *   Install dependencies: Yes
    *   **Emulators:**
        *   Select: Authentication, Functions, Firestore.
        *   Configure ports (defaults are usually fine).
        *   Download emulators: Yes.
    This step will create `firebase.json` and `.firebaserc` in your project root.

5.  **Install Function Dependencies:**
    Navigate to the Cloud Functions directory:
    ```bash
    cd backend/functions
    npm install
    cd ../..  # Go back to project root
    ```

## Running Locally with Firebase Emulators

The Firebase Emulator Suite allows you to run and test your backend locally.

1.  Navigate to the project root directory (e.g., `Chatterly/`).
2.  Start the emulators:
    ```bash
    firebase emulators:start
    ```
    This will typically start:
    *   Emulator UI: `http://localhost:4000`
    *   Authentication Emulator: `http://localhost:9099`
    *   Functions Emulator: `http://localhost:5001`
    *   Firestore Emulator: `http://localhost:8080`

    You can view logs, manage emulated auth users, and inspect emulated Firestore data via the Emulator UI.

## Deploying to Firebase

Once you've tested your backend and are ready to deploy to your live Firebase project:

1.  Navigate to the project root directory (e.g., `Chatterly/`).
2.  To deploy everything configured in `firebase.json`:
    ```bash
    firebase deploy
    ```
3.  To deploy only specific parts:
    *   Deploy Firestore rules:
        ```bash
        firebase deploy --only firestore:rules
        ```
    *   Deploy Cloud Functions:
        ```bash
        firebase deploy --only functions
        ```

## Key Components

### Firestore Security Rules
Located in `firestore.rules`. These rules define access control for your Firestore database, ensuring users can only access and modify data they are permitted to.

### Cloud Functions
Located in `functions/index.js`. These Node.js functions handle server-side logic:
-   `createUserProfile`: Triggered on new user authentication to create a user profile.
-   `setInitialProfileDetails`: Callable function for users to set their name and languages.
-   `createChat`: Callable function to initiate a chat between two users.
-   `sendMessage`: Callable function to send a message in a chat.
-   `blockUser`: Callable function to block another user.
-   `unblockUser`: Callable function to unblock a user.

### Firestore Data Structure
An example of the data structure can be found in `firestore-schema-example.json`.
-   `/users/{uid}`: Stores user profiles.
-   `/chats/{chatId}`: Stores chat metadata (participants, last message).
    -   `/chats/{chatId}/messages/{messageId}`: Subcollection for messages within a chat.

## Testing

-   **Manual Testing:** Use the Firebase Emulator Suite UI (`http://localhost:4000`) to:
    -   Create users in the Auth emulator.
    -   Inspect Firestore data.
    -   View function logs.
    -   Use the Firestore "Rules Playground" to test security rules.
-   **Callable Functions:** Test callable functions using `curl`, Postman, or a simple client-side script configured to use the emulators.
-   Refer to the Firebase documentation for more advanced testing strategies, including unit testing for security rules and functions. 